-- ============================================================================
-- EMERGENCY SINGLE-LINE SQL FALLBACK
-- ============================================================================
-- Use this to auto-create ONLY the most critical tables for app bootstrap.
-- This is a safety net for when the app needs to start immediately.
-- 
-- After using this, ALWAYS run the complete migration:
-- sql/supabase_migrations/004_migration_complete.sql
--
-- Copy the entire SQL statement below and paste into Supabase SQL Editor
-- ============================================================================

BEGIN; CREATE TABLE IF NOT EXISTS public.profiles (id UUID PRIMARY KEY, email TEXT UNIQUE NOT NULL, name TEXT, full_name TEXT, phone TEXT, password TEXT, role TEXT DEFAULT 'user' CHECK (role IN ('user', 'seller', 'admin')), wallet_balance NUMERIC(15,2) DEFAULT 0.00, suspended BOOLEAN DEFAULT FALSE, suspend_reason TEXT, created_at TIMESTAMPTZ DEFAULT NOW(), updated_at TIMESTAMPTZ DEFAULT NOW()); CREATE TABLE IF NOT EXISTS public.categories (id UUID PRIMARY KEY DEFAULT gen_random_uuid(), name TEXT NOT NULL UNIQUE, slug TEXT UNIQUE, description TEXT, image TEXT, item_count INT DEFAULT 0, created_at TIMESTAMPTZ DEFAULT NOW()); CREATE TABLE IF NOT EXISTS public.listings (id UUID PRIMARY KEY DEFAULT gen_random_uuid(), seller_id UUID REFERENCES public.profiles(id) ON DELETE SET NULL, title TEXT NOT NULL, description TEXT, price NUMERIC(15,2) NOT NULL, currency TEXT DEFAULT 'KES', category_id UUID REFERENCES public.categories(id) ON DELETE SET NULL, image TEXT, images JSONB DEFAULT '[]'::jsonb, stock INT DEFAULT 1, status TEXT DEFAULT 'active' CHECK (status IN ('active', 'sold', 'inactive')), views INT DEFAULT 0, favorites INT DEFAULT 0, created_at TIMESTAMPTZ DEFAULT NOW(), updated_at TIMESTAMPTZ DEFAULT NOW()); CREATE TABLE IF NOT EXISTS public.favorites (id UUID PRIMARY KEY DEFAULT gen_random_uuid(), user_id UUID NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE, item_id UUID NOT NULL REFERENCES public.listings(id) ON DELETE CASCADE, created_at TIMESTAMPTZ DEFAULT NOW(), UNIQUE(user_id, item_id)); CREATE TABLE IF NOT EXISTS public.conversations (id UUID PRIMARY KEY DEFAULT gen_random_uuid(), buyer_id UUID REFERENCES public.profiles(id) ON DELETE CASCADE, seller_id UUID REFERENCES public.profiles(id) ON DELETE CASCADE, item_id UUID REFERENCES public.listings(id) ON DELETE CASCADE, participant_1 UUID REFERENCES public.profiles(id) ON DELETE CASCADE, participant_2 UUID REFERENCES public.profiles(id) ON DELETE CASCADE, created_at TIMESTAMPTZ DEFAULT NOW(), updated_at TIMESTAMPTZ DEFAULT NOW()); CREATE TABLE IF NOT EXISTS public.messages (id UUID PRIMARY KEY DEFAULT gen_random_uuid(), conversation_id UUID NOT NULL REFERENCES public.conversations(id) ON DELETE CASCADE, sender_id UUID NOT NULL REFERENCES public.profiles(id) ON DELETE SET NULL, text TEXT, body TEXT, read BOOLEAN DEFAULT FALSE, created_at TIMESTAMPTZ DEFAULT NOW()); CREATE TABLE IF NOT EXISTS public.payments (id UUID PRIMARY KEY DEFAULT gen_random_uuid(), user_id UUID REFERENCES public.profiles(id) ON DELETE SET NULL, order_id UUID, amount NUMERIC(15,2) NOT NULL, currency TEXT DEFAULT 'KES', method TEXT DEFAULT 'mpesa', status TEXT DEFAULT 'pending' CHECK (status IN ('pending', 'completed', 'failed', 'cancelled')), confirmation JSONB, raw_metadata JSONB, created_at TIMESTAMPTZ DEFAULT NOW(), updated_at TIMESTAMPTZ DEFAULT NOW()); CREATE TABLE IF NOT EXISTS public.escrow_transactions (id UUID PRIMARY KEY DEFAULT gen_random_uuid(), item_id UUID REFERENCES public.listings(id) ON DELETE SET NULL, amount NUMERIC(15,2) NOT NULL, buyer_id UUID REFERENCES public.profiles(id) ON DELETE SET NULL, seller_id UUID REFERENCES public.profiles(id) ON DELETE SET NULL, order_id UUID, status TEXT DEFAULT 'pending' CHECK (status IN ('pending', 'held', 'released', 'refunded', 'disputed')), created_at TIMESTAMPTZ DEFAULT NOW(), released_at TIMESTAMPTZ, updated_at TIMESTAMPTZ DEFAULT NOW()); CREATE TABLE IF NOT EXISTS public.disputes (id UUID PRIMARY KEY DEFAULT gen_random_uuid(), escrow_id UUID REFERENCES public.escrow_transactions(id) ON DELETE CASCADE, reporter_id UUID REFERENCES public.profiles(id) ON DELETE SET NULL, initiator_id UUID REFERENCES public.profiles(id) ON DELETE SET NULL, defendant_id UUID REFERENCES public.profiles(id) ON DELETE SET NULL, reason TEXT, status TEXT DEFAULT 'open' CHECK (status IN ('open', 'in_progress', 'resolved', 'closed')), resolution TEXT, created_at TIMESTAMPTZ DEFAULT NOW(), resolved_at TIMESTAMPTZ, updated_at TIMESTAMPTZ DEFAULT NOW()); CREATE TABLE IF NOT EXISTS public.loans (id UUID PRIMARY KEY DEFAULT gen_random_uuid(), borrower_id UUID REFERENCES public.profiles(id) ON DELETE SET NULL, amount NUMERIC(15,2) NOT NULL, reason TEXT, term_months INT, requested_term_months INT, employment_status TEXT, annual_income NUMERIC(15,2), phone_number TEXT, email TEXT, id_number TEXT, dob DATE, gender TEXT, address TEXT, collateral TEXT, emergency_contact_name TEXT, emergency_contact_phone TEXT, bank_account TEXT, status TEXT DEFAULT 'pending' CHECK (status IN ('pending', 'approved', 'rejected', 'disbursed', 'completed')), approved_amount NUMERIC(15,2), interest_rate NUMERIC(6,3) DEFAULT 0.18, repayment_schedule JSONB, created_at TIMESTAMPTZ DEFAULT NOW(), updated_at TIMESTAMPTZ DEFAULT NOW()); CREATE TABLE IF NOT EXISTS public.loan_providers (id UUID PRIMARY KEY DEFAULT gen_random_uuid(), name TEXT NOT NULL UNIQUE, description TEXT, interest_rate NUMERIC(5,3), min_amount NUMERIC(15,2), max_amount NUMERIC(15,2), min_term_months INT, max_term_months INT, active BOOLEAN DEFAULT TRUE, created_at TIMESTAMPTZ DEFAULT NOW()); INSERT INTO public.loan_providers (name, interest_rate, min_amount, max_amount, min_term_months, max_term_months) VALUES ('BoltLoans', 0.12, 5000.00, 1000000.00, 6, 36), ('FastCredit', 0.15, 10000.00, 500000.00, 3, 24), ('QuickFunds', 0.18, 2000.00, 100000.00, 1, 12) ON CONFLICT (name) DO NOTHING; CREATE TABLE IF NOT EXISTS public.loan_repayments (id UUID PRIMARY KEY DEFAULT gen_random_uuid(), loan_id UUID NOT NULL REFERENCES public.loans(id) ON DELETE CASCADE, due_date DATE NOT NULL, amount NUMERIC(15,2) NOT NULL, paid BOOLEAN DEFAULT FALSE, paid_date TIMESTAMPTZ, created_at TIMESTAMPTZ DEFAULT NOW()); CREATE TABLE IF NOT EXISTS public.user_points (user_id UUID PRIMARY KEY REFERENCES public.profiles(id) ON DELETE CASCADE, points INT DEFAULT 0, created_at TIMESTAMPTZ DEFAULT NOW(), updated_at TIMESTAMPTZ DEFAULT NOW()); CREATE TABLE IF NOT EXISTS public.content_reports (id UUID PRIMARY KEY DEFAULT gen_random_uuid(), reporter_id UUID REFERENCES public.profiles(id) ON DELETE SET NULL, listing_id UUID REFERENCES public.listings(id) ON DELETE CASCADE, content_type TEXT DEFAULT 'listing' CHECK (content_type IN ('listing', 'user', 'message', 'review')), reason TEXT, description TEXT, status TEXT DEFAULT 'pending' CHECK (status IN ('pending', 'investigating', 'resolved', 'dismissed')), admin_action TEXT, action TEXT, created_at TIMESTAMPTZ DEFAULT NOW(), reviewed_at TIMESTAMPTZ, updated_at TIMESTAMPTZ DEFAULT NOW()); CREATE TABLE IF NOT EXISTS public.orders (id UUID PRIMARY KEY DEFAULT gen_random_uuid(), buyer_id UUID REFERENCES public.profiles(id) ON DELETE SET NULL, seller_id UUID REFERENCES public.profiles(id) ON DELETE SET NULL, listing_id UUID REFERENCES public.listings(id) ON DELETE SET NULL, total_amount NUMERIC(15,2) NOT NULL, currency TEXT DEFAULT 'KES', quantity INT DEFAULT 1, status TEXT DEFAULT 'pending' CHECK (status IN ('pending', 'confirmed', 'completed', 'cancelled', 'disputed')), payment_method TEXT, payment_released BOOLEAN DEFAULT FALSE, meta JSONB, created_at TIMESTAMPTZ DEFAULT NOW(), updated_at TIMESTAMPTZ DEFAULT NOW()); CREATE TABLE IF NOT EXISTS public.order_items (id UUID PRIMARY KEY DEFAULT gen_random_uuid(), order_id UUID NOT NULL REFERENCES public.orders(id) ON DELETE CASCADE, listing_id UUID REFERENCES public.listings(id) ON DELETE SET NULL, quantity INT DEFAULT 1, unit_price NUMERIC(15,2), created_at TIMESTAMPTZ DEFAULT NOW()); CREATE TABLE IF NOT EXISTS public.cart_items (id UUID PRIMARY KEY DEFAULT gen_random_uuid(), user_id UUID NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE, item_id UUID NOT NULL REFERENCES public.listings(id) ON DELETE CASCADE, quantity INT DEFAULT 1, unit_price NUMERIC(15,2), created_at TIMESTAMPTZ DEFAULT NOW(), updated_at TIMESTAMPTZ DEFAULT NOW()); CREATE TABLE IF NOT EXISTS public.payment_methods (id UUID PRIMARY KEY DEFAULT gen_random_uuid(), user_id UUID NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE, method TEXT NOT NULL CHECK (method IN ('bank_account', 'till_number', 'mpesa', 'pochi')), payload JSONB NOT NULL, verified BOOLEAN DEFAULT FALSE, verified_by UUID REFERENCES public.profiles(id) ON DELETE SET NULL, verify_reason TEXT, created_at TIMESTAMPTZ DEFAULT NOW(), updated_at TIMESTAMPTZ DEFAULT NOW(), verified_at TIMESTAMPTZ); CREATE TABLE IF NOT EXISTS public.seller_payouts (id UUID PRIMARY KEY DEFAULT gen_random_uuid(), seller_id UUID NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE, order_id UUID REFERENCES public.orders(id) ON DELETE SET NULL, amount NUMERIC(15,2) NOT NULL, status TEXT DEFAULT 'pending' CHECK (status IN ('pending', 'released', 'failed')), released_by UUID REFERENCES public.profiles(id) ON DELETE SET NULL, released_at TIMESTAMPTZ, created_at TIMESTAMPTZ DEFAULT NOW()); CREATE TABLE IF NOT EXISTS public.admin_logs (id UUID PRIMARY KEY DEFAULT gen_random_uuid(), admin_id UUID REFERENCES public.profiles(id) ON DELETE SET NULL, action TEXT NOT NULL, target_user_id UUID REFERENCES public.profiles(id) ON DELETE SET NULL, details JSONB, ip_address TEXT, created_at TIMESTAMPTZ DEFAULT NOW()); CREATE TABLE IF NOT EXISTS public.reviews (id UUID PRIMARY KEY DEFAULT gen_random_uuid(), listing_id UUID REFERENCES public.listings(id) ON DELETE CASCADE, user_id UUID REFERENCES public.profiles(id) ON DELETE SET NULL, rating INT CHECK (rating BETWEEN 1 AND 5), comment TEXT, helpful_count INT DEFAULT 0, created_at TIMESTAMPTZ DEFAULT NOW()); CREATE TABLE IF NOT EXISTS public.page_views (id UUID PRIMARY KEY DEFAULT gen_random_uuid(), user_id UUID REFERENCES public.profiles(id) ON DELETE SET NULL, path TEXT, referrer TEXT, metadata JSONB, created_at TIMESTAMPTZ DEFAULT NOW()); CREATE TABLE IF NOT EXISTS public.platform_stats (id UUID PRIMARY KEY DEFAULT gen_random_uuid(), date DATE NOT NULL UNIQUE, total_users INT DEFAULT 0, total_listings INT DEFAULT 0, total_orders INT DEFAULT 0, total_revenue NUMERIC(15,2) DEFAULT 0, stats JSONB, created_at TIMESTAMPTZ DEFAULT NOW()); CREATE INDEX IF NOT EXISTS idx_profiles_email ON public.profiles(email); CREATE INDEX IF NOT EXISTS idx_profiles_role ON public.profiles(role); CREATE INDEX IF NOT EXISTS idx_listings_seller_id ON public.listings(seller_id); CREATE INDEX IF NOT EXISTS idx_listings_category_id ON public.listings(category_id); CREATE INDEX IF NOT EXISTS idx_listings_status ON public.listings(status); CREATE INDEX IF NOT EXISTS idx_listings_created_at ON public.listings(created_at DESC); CREATE INDEX IF NOT EXISTS idx_favorites_user_id ON public.favorites(user_id); CREATE INDEX IF NOT EXISTS idx_favorites_item_id ON public.favorites(item_id); CREATE INDEX IF NOT EXISTS idx_messages_conversation_id ON public.messages(conversation_id); CREATE INDEX IF NOT EXISTS idx_messages_sender_id ON public.messages(sender_id); CREATE INDEX IF NOT EXISTS idx_messages_created_at ON public.messages(created_at DESC); CREATE INDEX IF NOT EXISTS idx_payments_user_id ON public.payments(user_id); CREATE INDEX IF NOT EXISTS idx_payments_status ON public.payments(status); CREATE INDEX IF NOT EXISTS idx_orders_buyer_id ON public.orders(buyer_id); CREATE INDEX IF NOT EXISTS idx_orders_seller_id ON public.orders(seller_id); CREATE INDEX IF NOT EXISTS idx_orders_status ON public.orders(status); CREATE INDEX IF NOT EXISTS idx_loans_borrower_id ON public.loans(borrower_id); CREATE INDEX IF NOT EXISTS idx_loans_status ON public.loans(status); CREATE INDEX IF NOT EXISTS idx_content_reports_listing_id ON public.content_reports(listing_id); CREATE INDEX IF NOT EXISTS idx_content_reports_status ON public.content_reports(status); COMMIT;
